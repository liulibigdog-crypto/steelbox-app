# è‡ªå®šä¹‰CSSæ ·å¼
st.markdown("""
    <style>
    /* é¡µé¢æ•´ä½“å±…ä¸­ */
    .block-container {
        max-width: 850px;  /* å†…å®¹å®½åº¦ */
        margin: auto;      /* å±…ä¸­ */
        padding-top: 2rem;
        padding-bottom: 2rem;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0px 0px 15px rgba(0,0,0,0.08);
    }
    /* é¡µé¢èƒŒæ™¯ä¸æ°´å° */
    body {
        background: #f7f9fb;
        background-image: url("https://via.placeholder.com/400x400.png?text=Lichen+Liu");
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        background-size: 50%;
        opacity: 0.98;
    }
    /* è®©æ°´å°æ·¡åŒ– */
    body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.7);
        z-index: -1;
    }
    </style>
    """, unsafe_allow_html=True)

# app.py
import io
import math
import streamlit as st
import matplotlib.pyplot as plt
from matplotlib.patches import Rectangle

st.set_page_config(page_title="é’¢ç®±æ¢æˆªé¢å¿«é€Ÿè®¾è®¡", page_icon="ğŸ§®", layout="wide")

# ============ é¡¶éƒ¨æ  ============
left, mid, right = st.columns([1.2, 1, 1])
with left:
    st.markdown("### ğŸ§® é’¢ç®±æ¢æˆªé¢å¿«é€Ÿè®¾è®¡å°å·¥å…·")
with mid:
    st.markdown(
        "<div style='text-align:center; font-size:14px; color:gray;'>"
        "æ–¹æ¡ˆé˜¶æ®µå¿«é€Ÿåˆé€‰ Â· å¯è§†åŒ– Â· å‚æ•°åŒ–</div>", unsafe_allow_html=True)
with right:
    st.markdown("<div style='text-align:right;'>Made by <b>Lichen Liu</b></div>", unsafe_allow_html=True)

st.markdown("---")

# ============ é€‰é¡¹å¡ ============
tab1, tab2, tab3 = st.tabs(["â‘  å‚æ•°è¾“å…¥", "â‘¡ ç»“æœä¸ç¤ºæ„", "â‘¢ è¯´æ˜ä¸æ–¹æ³•"])

# ============ ä¾§è¾¹æ ï¼ˆå…¨å±€ï¼‰ ============
with st.sidebar:
    st.image("https://img.icons8.com/fluency/96/bridge.png", width=64)
    st.markdown("#### è®¾ç½®")
    theme = st.selectbox("æ˜¾ç¤ºä¸»é¢˜", ["é»˜è®¤", "ç´§å‡‘", "å¤§å·"], index=0)
    st.caption("æç¤ºï¼šæœ€ç»ˆæ’ç‰ˆä»¥è®ºæ–‡éœ€æ±‚ä¸ºå‡†ï¼Œæˆªå›¾å‰å¯åˆ‡æ¢ä¸»é¢˜è§‚æ„Ÿã€‚")

# ============ â‘  å‚æ•°è¾“å…¥ ============
with tab1:
    st.subheader("è¾“å…¥å‚æ•°")
    c1, c2, c3 = st.columns(3)
    with c1:
        M_pos = st.number_input("è·¨ä¸­æ­£å¼¯çŸ© M+ (kNÂ·m)", value=15400.0, step=100.0, min_value=0.0)
        V = st.number_input("æ”¯ç‚¹æœ€å¤§å‰ªåŠ› V (kN)", value=5360.0, step=50.0, min_value=0.0)
        fy = st.number_input("é’¢æå±ˆæœå¼ºåº¦ fy (MPa)", value=345.0, step=5.0, min_value=100.0)
    with c2:
        M_neg = st.number_input("æ”¯ç‚¹è´Ÿå¼¯çŸ© M- (kNÂ·m)", value=32200.0, step=100.0, min_value=0.0)
        B_deck = st.number_input("å•å¹…æ¡¥é¢æ€»å®½ B (m)", value=13.5, step=0.1, min_value=4.0)
        gamma0 = st.number_input("é‡è¦æ€§ç³»æ•° Î³0", value=1.1, step=0.05, min_value=1.0)
    with c3:
        H = st.number_input("æ¢é«˜ H (m)", value=2.0, step=0.1, min_value=0.6)
        eta_beff = st.slider("ç¿¼ç¼˜æœ‰æ•ˆå®½åº¦æŠ˜å‡ç³»æ•° Î· (0.30â€“0.40)", 0.30, 0.40, 0.35, 0.01)
        st.caption("æ³¨ï¼šÎ· å–å€¼è¶Šå°è¶Šä¿å®ˆï¼›æ¨ªéš”è¾ƒç–ã€åè½½æ˜æ˜¾æ—¶å»ºè®®å– 0.30â€“0.33ã€‚")

    st.info("ç‚¹å‡»é¡¶éƒ¨åˆ‡æ¢åˆ°â€œâ‘¡ ç»“æœä¸ç¤ºæ„â€æŸ¥çœ‹å¯è§†åŒ–ä¸æ ¡æ ¸æç¤ºã€‚")

# ============ è®¡ç®—æ ¸å¿ƒï¼ˆå…¨å±€ç”¨ï¼‰ ============
fd = fy / gamma0                        # è®¾è®¡å¼ºåº¦ (MPa = N/mm2)
M_pos_Nmm = M_pos * 1e6                 # kNÂ·m -> NÂ·mm
M_neg_Nmm = M_neg * 1e6

# æ‰€éœ€æˆªé¢æ¨¡é‡ï¼ˆmm3ï¼‰
Wreq_pos = M_pos_Nmm / fd
Wreq_neg = M_neg_Nmm / fd

# ç»éªŒï¼šå•ç®±å¤–å®½çº¦ 0.65~0.80 Bï¼Œè¿™é‡Œå– 0.70Â·B åˆé€‰
B_box = 0.70 * B_deck                   # m
beff = eta_beff * (0.85 * B_box)        # mï¼ˆ0.85 ä¸ºå¤–ä¼¸ä¸å®‰å…¨æŠ˜å‡ï¼Œå·¥ç¨‹ç»éªŒï¼‰
B_box_mm = B_box * 1000
beff_mm = beff * 1000
H_mm = H * 1000

# åˆé€‰åšåº¦ï¼ˆæ§åˆ¶ä¾§æ³•ï¼ŒHfâ‰ˆHï¼‰
t_bot = Wreq_pos / (H_mm * beff_mm)     # mmï¼Œè·¨ä¸­æ­£å¼¯çŸ©æ§åˆ¶åº•æ¿
t_top = Wreq_neg / (H_mm * beff_mm)     # mmï¼Œæ”¯ç‚¹è´Ÿå¼¯çŸ©æ§åˆ¶é¡¶æ¿

# è…¹æ¿åšåº¦ï¼ˆå‰ªåŠ›åˆé€‰ï¼ŒV â‰¤ 0.58 fy t_w h_wï¼‰
tau_allow = 0.58 * fy
t_web_min = (V * 1e3) / (tau_allow * H_mm) if H_mm > 0 else 0.0
t_web = max(t_web_min, 12.0)            # æ„é€ ä¸‹é™ 12mm å¯æŒ‰é¡¹ç›®è°ƒæ•´

# æ¨èç®±å®¤æ•°ï¼ˆæ¯å®¤å®½ç›®æ ‡çº¦ 3.0 mï¼Œé™åˆ¶ 1~4ï¼‰
target_cell_w = 3.0
Nc_guess = max(1, min(4, int(round(B_box / target_cell_w))))
# å…è®¸æ‰‹åŠ¨è¦†ç›–ï¼ˆæ”¾åœ¨ç»“æœé¡µæ›´ç›´è§‚ï¼‰
# ============ â‘¡ ç»“æœä¸ç¤ºæ„ ============
with tab2:
    st.subheader("æ¨èæˆªé¢ä¸æ ¡æ ¸æç¤º")

    # å¸ƒå±€ï¼šå·¦ç»“æœå¡ç‰‡ï¼Œå³ç¤ºæ„å›¾
    left, right = st.columns([1.1, 1.2], gap="large")

    with left:
        st.markdown("##### å…³é”®éœ€æ±‚ä¸å»ºè®®")
        # ä¸‰å¼ â€œå¡ç‰‡â€é£æ ¼
        cA, cB, cC = st.columns(3)
        cA.metric("Wreq+ (Ã—10â¶ mmÂ³)", f"{Wreq_pos/1e6:.1f}")
        cB.metric("Wreq- (Ã—10â¶ mmÂ³)", f"{Wreq_neg/1e6:.1f}")
        cC.metric("B_box çº¦ (m)", f"{B_box:.2f}")

        Nc = st.selectbox("æ¨èå•ç®±ç®±å®¤æ•°ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰", [1,2,3,4], index=Nc_guess-1,
                          help="æ¯å®¤å®½çº¦ 2.5â€“3.5 mï¼Œå–ä½¿æ¯å®¤å®½æ¥è¿‘ 3.0 m çš„æ•´æ•°ï¼›æœ€ç»ˆéœ€ç»“åˆæ‰­è½¬ä¸æ¨ªéš”å¸ƒç½®ç¡®å®šã€‚")
        n_webs = Nc + 1

        st.markdown("##### åˆé€‰å°ºå¯¸ï¼ˆæ–¹æ¡ˆé˜¶æ®µï¼‰")
        st.write(f"- é¡¶æ¿åšåº¦  **t_top**  â‰ˆ {t_top:.1f} mm  ï¼ˆè´Ÿå¼¯çŸ©æ§åˆ¶ï¼‰")
        st.write(f"- åº•æ¿åšåº¦  **t_bot**  â‰ˆ {t_bot:.1f} mm  ï¼ˆæ­£å¼¯çŸ©æ§åˆ¶ï¼‰")
        st.write(f"- è…¹æ¿åšåº¦  **t_web** â‰¥ {t_web:.1f} mmï¼ˆå‰ªåŠ›åˆé€‰ï¼Œæ„é€ ä¸‹é™ 12 mmï¼‰")
        st.write(f"- æ¨èç®±å®¤æ•° **Nc** = {Nc}ï¼ˆæ€»è…¹æ¿æ•° {n_webs}ï¼‰")

        # ç®€å•â€œæ»¡è¶³/ä¸æ»¡è¶³â€æç¤ºï¼ˆä»¥åç®—çš„ Wact æ¥çœ‹ marginï¼‰
        Wact_bot = H_mm * beff_mm * t_bot
        Wact_top = H_mm * beff_mm * t_top
        ok_bot = Wact_bot >= Wreq_pos * 0.999
        ok_top = Wact_top >= Wreq_neg * 0.999

        if ok_bot and ok_top:
            st.success("æŠ—å¼¯éœ€æ±‚æ»¡è¶³ï¼ˆæ§åˆ¶ä¾§æ³•ï¼ŒHfâ‰ˆHï¼Œæœ‰æ•ˆå®½åº¦æ³•ä¼°ç®—ï¼‰ã€‚")
        else:
            st.error("æŠ—å¼¯éœ€æ±‚æœªæ»¡è¶³ï¼Œè¯·å¢åšç¿¼ç¼˜æˆ–è°ƒæ•´æ¢é«˜/æœ‰æ•ˆå®½åº¦ã€‚")

        # å¯¼å‡ºæ•°æ®ï¼ˆCSVï¼‰
        import pandas as pd
        df = pd.DataFrame({
            "å‚æ•°":["Wreq+ (mm^3)","Wreq- (mm^3)","B_box (m)","Nc",
                   "t_top (mm)","t_bot (mm)","t_web_min (mm)","t_web(å»ºè®®,mm)"],
            "æ•°å€¼":[Wreq_pos, Wreq_neg, B_box, Nc, t_top, t_bot, t_web_min, t_web]
        })
        st.download_button("ä¸‹è½½ç»“æœ CSV", data=df.to_csv(index=False).encode("utf-8-sig"),
                           file_name="steel_box_section_results.csv", mime="text/csv")

    with right:
        st.markdown("##### æ¨èæˆªé¢ç¤ºæ„ï¼ˆéæ¯”ä¾‹ï¼Œä»…ä¾›å±•ç¤ºï¼‰")

        def draw_section(B_box_mm, H_mm, t_top, t_bot, Nc):
            fig, ax = plt.subplots(figsize=(8, 4), dpi=150)
            # å¤–è½®å»“
            ax.add_patch(Rectangle((0, 0), B_box_mm, H_mm, fill=False, linewidth=1.6))
            # é¡¶/åº•æ¿
            ax.add_patch(Rectangle((0, H_mm - t_top), B_box_mm, t_top, fill=True, alpha=0.18))
            ax.add_patch(Rectangle((0, 0), B_box_mm, t_bot, fill=True, alpha=0.18))
            # å†…è…¹æ¿ï¼ˆç­‰åˆ†ï¼‰
            if Nc >= 2:
                spacing = B_box_mm / Nc
                for i in range(1, Nc):
                    x = i * spacing
                    ax.add_line(plt.Line2D([x, x], [t_bot, H_mm - t_top], linewidth=1.2))
            # æ³¨é‡Š
            ax.text(B_box_mm/2, H_mm + 0.035*H_mm, f"B_box â‰ˆ {B_box_mm/1000:.2f} m", ha="center", va="bottom")
            ax.text(-0.03*B_box_mm, H_mm/2, f"H = {H_mm/1000:.2f} m", ha="right", va="center", rotation=90)
            ax.text(B_box_mm*0.02, H_mm - t_top/2, f"t_topâ‰ˆ{t_top:.0f} mm", va="center")
            ax.text(B_box_mm*0.02, t_bot/2, f"t_botâ‰ˆ{t_bot:.0f} mm", va="center")
            ax.set_aspect('equal'); ax.set_xlim(-0.1*B_box_mm, 1.1*B_box_mm); ax.set_ylim(-0.1*H_mm, 1.15*H_mm)
            ax.axis('off')
            return fig

        fig = draw_section(B_box_mm, H_mm, t_top, t_bot, Nc)
        st.pyplot(fig, clear_figure=True)

        # ä¸‹è½½ PNG
        buf = io.BytesIO()
        fig.savefig(buf, format="png", bbox_inches="tight")
        st.download_button("ä¸‹è½½ç¤ºæ„å›¾ PNG", data=buf.getvalue(),
                           file_name="steel_box_section.png", mime="image/png")

# ============ â‘¢ è¯´æ˜ä¸æ–¹æ³• ============
with tab3:
    st.subheader("ç®—æ³•ä¸ä½¿ç”¨è¯´æ˜ï¼ˆæ‘˜è¦ï¼‰")
    st.markdown(
        """
- **æŠ—å¼¯**ï¼šæŒ‰æ§åˆ¶ä¾§åŸåˆ™å¹¶é‡‡ç”¨æœ‰æ•ˆå®½åº¦æ³•ä¼°ç®—ç¿¼ç¼˜æŠµæŠ—çŸ©ï¼›æ»¡è¶³ \(W_{act} \ge W_{req}\)ã€‚
- **æŠ—å‰ª**ï¼šæŒ‰ \(V \le 0.58 f_y\, t_w\, h_w\) åˆé€‰è…¹æ¿åšåº¦ï¼›æ–¹æ¡ˆé˜¶æ®µè®¾å®šæ„é€ ä¸‹é™ï¼ˆå¦‚ 12 mmï¼‰ã€‚
- **ç®±å®¤**ï¼šç»éªŒæ¨èå•ç®±å¤–å®½çº¦ \(0.65\sim0.80\,B\)ï¼Œæ¯å®¤å®½ \(2.5\sim3.5\) mï¼Œæ®æ­¤å»ºè®® \(N_c\) å¹¶å…è®¸æ‰‹åŠ¨è¦†ç›–ã€‚
- **å®šä½**ï¼šæœ¬å·¥å…·ç”¨äºæ–¹æ¡ˆé˜¶æ®µå¿«é€Ÿåˆé€‰ï¼Œå®šå‹éœ€åšå¼ºåº¦ã€ç¨³å®šã€å®½åšæ¯”ã€ç–²åŠ³ä¸æ„é€ ç­‰è¯¦éªŒç®—ã€‚
        """
    )
    st.caption("Â© 2025 Lichen Liu | æ•™å­¦ä¸æ–¹æ¡ˆæ¯”é€‰ç”¨é€”ã€‚")
