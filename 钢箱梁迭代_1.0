# -*- coding: utf-8 -*-
import io
import math
import time # ç”¨äºæ¨¡æ‹Ÿè®¡ç®—å»¶æ—¶æ•ˆæœï¼ˆå¯é€‰ï¼‰
import numpy as np
import pandas as pd
import streamlit as st
import matplotlib.pyplot as plt
from matplotlib.patches import Rectangle, Polygon

# =============== 1. æ ¸å¿ƒè®¡ç®—ç±» (é€»è¾‘å±‚ - å«è¿­ä»£ä¼˜åŒ–) ===============
class BoxGirderSection:
    def __init__(self, B_box_mm, H_mm, t_top, t_bot, t_web, Nc, fy, gamma0, 
                 t_top_min=16, t_bot_min=14, t_web_min=12):
        self.B = B_box_mm
        self.H = H_mm
        # åˆå§‹èµ‹å€¼
        self.t_top = t_top
        self.t_bot = t_bot
        self.t_web = t_web
        
        # æ„é€ çº¦æŸ
        self.t_top_min = t_top_min
        self.t_bot_min = t_bot_min
        self.t_web_min = t_web_min
        
        self.Nc = Nc
        self.n_webs = Nc + 1
        self.fy = fy
        self.fd = fy / gamma0
        self.tau_allow = 0.58 * fy
        
        # çŠ¶æ€è®°å½•
        self.log = [] 
        
        # åˆå§‹åŒ–è®¡ç®—
        self._calc_properties()

    def _calc_properties(self):
        """è®¡ç®—æˆªé¢å‡ ä½•å±æ€§"""
        # 1. é¡¶æ¿ (ç®€åŒ–è®¡ç®—)
        A_top = self.B * self.t_top
        y_top = self.H - self.t_top / 2
        
        # 2. åº•æ¿
        A_bot = self.B * self.t_bot
        y_bot = self.t_bot / 2
        
        # 3. è…¹æ¿
        h_web_net = self.H - self.t_top - self.t_bot
        # é˜²æ­¢åšåº¦è¿‡å¤§å¯¼è‡´å‡ ä½•é”™è¯¯
        if h_web_net < 0: h_web_net = 0 
        
        A_webs = self.n_webs * self.t_web * h_web_net
        y_webs = self.t_bot + h_web_net / 2
        
        # æ€»é¢ç§¯ & å½¢å¿ƒ
        self.Area = A_top + A_bot + A_webs
        if self.Area <= 0: self.Area = 1.0 # é¿å…é™¤é›¶
        
        self.y_c = (A_top * y_top + A_bot * y_bot + A_webs * y_webs) / self.Area
        
        # æƒ¯æ€§çŸ©
        I_top = (self.B * self.t_top**3)/12 + A_top * (y_top - self.y_c)**2
        I_bot = (self.B * self.t_bot**3)/12 + A_bot * (y_bot - self.y_c)**2
        I_webs = self.n_webs * ((self.t_web * h_web_net**3)/12 + (self.t_web * h_web_net) * (y_webs - self.y_c)**2)
        
        self.Ixx = I_top + I_bot + I_webs
        
        # æŠ—å¼¯æ¨¡é‡ (ä¸Šä¸‹ç¼˜)
        self.W_top = self.Ixx / (self.H - self.y_c) if (self.H - self.y_c) > 0 else 1e9
        self.W_bot = self.Ixx / self.y_c if self.y_c > 0 else 1e9

    def check_capacity(self, M_pos_kN, M_neg_kN, V_kN):
        """æ ¡æ ¸å½“å‰åšåº¦ä¸‹çš„åº”åŠ›"""
        self._calc_properties()
        
        # åº”åŠ›è®¡ç®— (MPa)
        # æ­£å¼¯çŸ©å·¥å†µ (ä¸Šå‹ä¸‹æ‹‰)
        sig_top_pos = (M_pos_kN * 1e6) / self.W_top
        sig_bot_pos = (M_pos_kN * 1e6) / self.W_bot
        
        # è´Ÿå¼¯çŸ©å·¥å†µ (ä¸Šæ‹‰ä¸‹å‹)
        sig_top_neg = (M_neg_kN * 1e6) / self.W_top
        sig_bot_neg = (M_neg_kN * 1e6) / self.W_bot
        
        # å‰ªåº”åŠ›
        h_w = 0.9 * self.H
        tau = (V_kN * 1e3) / (self.n_webs * self.t_web * h_w)
        
        # æå–æœ€å¤§æ§åˆ¶åº”åŠ›
        # é¡¶æ¿æ§åˆ¶åº”åŠ› (ç”±æ­£å¼¯çŸ©å‹åº”åŠ› æˆ– è´Ÿå¼¯çŸ©æ‹‰åº”åŠ›æ§åˆ¶)
        sig_top_max = max(sig_top_pos, sig_top_neg)
        # åº•æ¿æ§åˆ¶åº”åŠ›
        sig_bot_max = max(sig_bot_pos, sig_bot_neg)
        
        return {
            "ur_top": sig_top_max / self.fd,
            "ur_bot": sig_bot_max / self.fd,
            "ur_shear": tau / self.tau_allow,
            "ur_max": max(sig_top_max/self.fd, sig_bot_max/self.fd, tau/self.tau_allow)
        }

    def optimize(self, M_pos, M_neg, V, max_iter=20):
        """
        è‡ªåŠ¨è¿­ä»£ä¼˜åŒ–å‡½æ•°
        ç­–ç•¥ï¼šè´ªå¿ƒç®—æ³• + æ­¥è¿›é€¼è¿‘
        """
        self.log = [] # æ¸…ç©ºæ—¥å¿—
        success = False
        
        for i in range(1, max_iter + 1):
            res = self.check_capacity(M_pos, M_neg, V)
            ur_max = res['ur_max']
            ur_top = res['ur_top']
            ur_bot = res['ur_bot']
            ur_shear = res['ur_shear']
            
            # è®°å½•å½“å‰çŠ¶æ€
            status_msg = f"Iter {i:02d}: t=({self.t_top}, {self.t_bot}, {self.t_web}) -> UR_max={ur_max:.3f}"
            self.log.append(status_msg)
            
            # ç»ˆæ­¢æ¡ä»¶ï¼šåˆ©ç”¨ç‡åœ¨ 0.90 ~ 1.00 ä¹‹é—´ï¼Œä¸”æ²¡æœ‰å‰ªåˆ‡è¶…é™
            if 0.90 <= ur_max <= 1.00:
                success = True
                self.log.append(f"âœ… åœ¨ç¬¬ {i} æ¬¡è¿­ä»£æ”¶æ•›åˆ°æœ€ä¼˜åŒºé—´ (0.9-1.0)ã€‚")
                break
            
            # ç­–ç•¥è°ƒæ•´
            step = 2.0 # mm
            
            # æƒ…å†µ1ï¼šä¸å®‰å…¨ (UR > 1.0) -> åŠ åš
            if ur_max > 1.0:
                # å“ªä¸ªä¸å¤ŸåŠ å“ªä¸ª
                if ur_shear > 1.0:
                    self.t_web += step
                elif ur_top > 1.0 and ur_top >= ur_bot:
                    self.t_top += step
                elif ur_bot > 1.0 and ur_bot > ur_top:
                    self.t_bot += step
                else:
                    # å¦‚æœéƒ½å·®ä¸å¤šï¼Œä¼˜å…ˆåŠ æœ€è–„çš„ï¼Œæˆ–è€…åŠ è¿œç¦»å½¢å¿ƒçš„
                    if self.t_top < self.t_bot: self.t_top += step
                    else: self.t_bot += step
            
            # æƒ…å†µ2ï¼šå¤ªå®‰å…¨ (UR < 0.90) -> å‡è–„
            elif ur_max < 0.90:
                # å°è¯•å‡è–„åˆ©ç”¨ç‡æœ€ä½çš„éƒ¨åˆ†ï¼Œä½†ä¸èƒ½ä½äºæ„é€ è¦æ±‚
                
                # å‰ªåˆ‡è£•é‡å¾ˆå¤§ï¼Œä¸”åšåº¦å¤§äºæœ€å°å€¼
                if ur_shear < 0.6 and self.t_web > self.t_web_min:
                    self.t_web -= step
                
                # å¼¯æ›²è£•é‡å¤§
                elif ur_top < 0.8 and self.t_top > self.t_top_min:
                    self.t_top -= step
                elif ur_bot < 0.8 and self.t_bot > self.t_bot_min:
                    self.t_bot -= step
                else:
                    # æ— æ³•å†å‡è–„ï¼ˆå·²è§¦åº•æ„é€ è¦æ±‚ï¼‰
                    self.log.append("âš ï¸ è¾¾åˆ°æ„é€ æœ€å°åšåº¦é™åˆ¶ï¼Œæ— æ³•è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚")
                    success = True
                    break
            
        return success, self.log

# =============== 2. ç»˜å›¾å‡½æ•° (ä¿æŒä¸å˜ï¼Œçœç•¥ä»¥èŠ‚çœç¯‡å¹…ï¼Œç›´æ¥å¼•ç”¨ä¸Šä¸€ç‰ˆ) ===============
# (æ­¤å¤„å‡è®¾å·²åŒ…å«ä¸Šæ–‡çš„ draw_section_cad å’Œ draw_section_3d å‡½æ•°)
# ä¸ºç¡®ä¿ä»£ç å®Œæ•´è¿è¡Œï¼Œè¿™é‡Œç®€ç•¥å®šä¹‰ï¼Œå®é™…è¯·ä½¿ç”¨ä¸Šä¸€ç‰ˆå®Œæ•´ä»£ç 
@st.cache_data(show_spinner=False)
def draw_section_cad(B_deck, B_box_mm, H_mm, t_top, t_bot, t_web, Nc, out_top, out_bot, e_web, dim_gap=120):
    fig, ax = plt.subplots(figsize=(8, 4))
    ax.text(0.5, 0.5, "Drawing Updated...", ha='center') # å ä½
    return fig
@st.cache_data(show_spinner=False)
def draw_section_3d(*args, **kwargs):
    fig, ax = plt.subplots()
    return fig
# -------------------------------------------------------------------------
# è¯·åŠ¡å¿…å°†ä¸Šä¸€ä¸ªå›å¤ä¸­å®Œæ•´çš„ draw_section_cad å’Œ draw_section_3d å¤åˆ¶å›æ¥
# -------------------------------------------------------------------------

# =============== 3. ä¸»ç¨‹åº UI ===============
def main():
    st.set_page_config(page_title="é’¢ç®±æ¢æ™ºèƒ½è®¾è®¡ v3", page_icon="ğŸ¤–", layout="wide")
    
    # Session State åˆå§‹åŒ– (ç”¨äºå­˜å‚¨ä¼˜åŒ–åçš„ç»“æœ)
    if 'opt_t_top' not in st.session_state: st.session_state.opt_t_top = 20
    if 'opt_t_bot' not in st.session_state: st.session_state.opt_t_bot = 18
    if 'opt_t_web' not in st.session_state: st.session_state.opt_t_web = 14
    if 'opt_run' not in st.session_state: st.session_state.opt_run = False

    st.markdown("""
    <style>
    .main .block-container{ max-width: 1400px; padding-top: 1rem; }
    .stButton button { width: 100%; border-radius: 8px; font-weight: bold; }
    .log-box { font-family: 'Courier New'; font-size: 13px; background: #f8f9fa; padding: 10px; border-radius: 8px; height: 200px; overflow-y: auto; border: 1px solid #ddd;}
    </style>
    """, unsafe_allow_html=True)

    st.title("ğŸ¤– é’¢ç®±æ¢æˆªé¢æ™ºèƒ½è®¾è®¡ (Iterative Design)")
    
    # --- ä¾§è¾¹æ  ---
    with st.sidebar:
        st.header("1. åŸºç¡€æ¡ä»¶")
        with st.expander("å†…åŠ›ä¸å‡ ä½•", expanded=True):
            M_pos = st.number_input("M+ (kNÂ·m)", 15400.0, step=500.0)
            M_neg = st.number_input("M- (kNÂ·m)", 32200.0, step=500.0)
            V     = st.number_input("V (kN)",    5360.0, step=100.0)
            B_deck = st.number_input("æ¡¥å®½ B (m)", 13.5)
            H      = st.number_input("æ¢é«˜ H (m)", 2.0)
            B_box  = st.number_input("ç®±å®½ B_box (m)", 9.5)
            Nc     = st.selectbox("ç®±å®¤æ•° Nc", [1,2,3,4], index=2)
        
        st.header("2. æ„é€ é™åˆ¶")
        fy = st.number_input("é’¢æ fy (MPa)", 345.0)
        gamma0 = 1.1
        
        c1, c2, c3 = st.columns(3)
        min_top = c1.number_input("miné¡¶", 16)
        min_bot = c2.number_input("minåº•", 14)
        min_web = c3.number_input("minè…¹", 12)

    # --- é¡¶éƒ¨ï¼šä¼˜åŒ–æ§åˆ¶åŒº ---
    st.markdown("### ğŸ¯ æ™ºèƒ½ä¼˜åŒ–æ§åˆ¶å°")
    col_opt1, col_opt2, col_opt3 = st.columns([0.2, 0.5, 0.3])
    
    with col_opt1:
        st.info("ğŸ’¡ ç‚¹å‡»æŒ‰é’®ï¼Œç®—æ³•å°†åœ¨20æ­¥å†…è‡ªåŠ¨å¯»æ‰¾æ»¡è¶³å¼ºåº¦ä¸”æœ€çœæçš„æˆªé¢ã€‚")
        if st.button("ğŸš€ å¼€å§‹è‡ªåŠ¨ä¼˜åŒ– (Auto Optimize)", type="primary"):
            # 1. å®ä¾‹åŒ–ä¸€ä¸ªåˆå§‹å¯¹è±¡ (ä½¿ç”¨æœ€å°æ„é€ åšåº¦ä½œä¸ºèµ·ç‚¹ï¼Œæˆ–è€…å½“å‰å€¼)
            section_opt = BoxGirderSection(
                B_box * 1000, H * 1000, 
                min_top, min_bot, min_web, # ä»æœ€å°å€¼å¼€å§‹çˆ¬å‡
                Nc, fy, gamma0, 
                min_top, min_bot, min_web
            )
            
            with st.spinner("æ­£åœ¨è¿›è¡Œæœ‰é™æ­¥è¿›è¿­ä»£è®¡ç®—..."):
                success, logs = section_opt.optimize(M_pos, M_neg, V, max_iter=20)
                time.sleep(0.5) # ç¨å¾®åœé¡¿å±•ç¤ºåŠ è½½åŠ¨ç”»
            
            # æ›´æ–° Session State
            st.session_state.opt_t_top = int(section_opt.t_top)
            st.session_state.opt_t_bot = int(section_opt.t_bot)
            st.session_state.opt_t_web = int(section_opt.t_web)
            st.session_state.opt_logs = logs
            st.session_state.opt_run = True
            st.rerun() # å¼ºåˆ¶åˆ·æ–°é¡µé¢åº”ç”¨æ–°å€¼

    # --- ä¸­é—´ï¼šå‚æ•°è°ƒæ•´ä¸ç»“æœå±•ç¤º ---
    
    # ä½¿ç”¨ Session State çš„å€¼æˆ–é»˜è®¤å€¼
    st.markdown("---")
    c_in1, c_in2 = st.columns([0.3, 0.7])
    
    with c_in1:
        st.subheader("ğŸ› ï¸ æˆªé¢å‚æ•° (å¯å¾®è°ƒ)")
        # è¿™é‡Œçš„å€¼ç»‘å®šåˆ° Session Stateï¼Œè¿™æ ·ä¼˜åŒ–åä¼šè‡ªåŠ¨æ›´æ–°
        t_top = st.number_input("é¡¶æ¿åš (mm)", value=st.session_state.opt_t_top, step=2, key='input_top')
        t_bot = st.number_input("åº•æ¿åš (mm)", value=st.session_state.opt_t_bot, step=2, key='input_bot')
        t_web = st.number_input("è…¹æ¿åš (mm)", value=st.session_state.opt_t_web, step=2, key='input_web')
        
        # å®ä¾‹åŒ–å½“å‰æ˜¾ç¤ºçš„æˆªé¢
        current_section = BoxGirderSection(
            B_box*1000, H*1000, t_top, t_bot, t_web, Nc, fy, gamma0, 
            min_top, min_bot, min_web
        )
        res = current_section.check_capacity(M_pos, M_neg, V)
        
        # è¿­ä»£æ—¥å¿—å±•ç¤ºåŒº
        if st.session_state.opt_run:
            with st.expander("æŸ¥çœ‹ä¼˜åŒ–è¿­ä»£æ—¥å¿— (Optimization Log)", expanded=True):
                log_text = "\n".join(st.session_state.opt_logs)
                st.markdown(f'<div class="log-box">{log_text}</div>', unsafe_allow_html=True)

    with c_in2:
        st.subheader("ğŸ“Š å®æ—¶éªŒç®—ç»“æœ")
        
        # ä»ªè¡¨ç›˜æ ·å¼
        m1, m2, m3, m4 = st.columns(4)
        m1.metric("æˆªé¢é¢ç§¯", f"{current_section.Area/1e4:.1f} cmÂ²", delta_color="inverse")
        m2.metric("æœ€å¤§åº”åŠ›", f"{res['ur_max']*current_section.fd:.0f} MPa", f"{(res['ur_max']-1)*100:.1f}%")
        
        # è¿›åº¦æ¡
        st.write("å¼¯æ›²åˆ©ç”¨ç‡ (Flexure UR)")
        u_flex = max(res['ur_top'], res['ur_bot'])
        bar_color = "red" if u_flex > 1.0 else ("orange" if u_flex > 0.9 else "green")
        st.progress(min(u_flex, 1.0))
        st.caption(f"å½“å‰: {u_flex:.2f} / ç›®æ ‡: 0.90-1.00")
        
        st.write("å‰ªåˆ‡åˆ©ç”¨ç‡ (Shear UR)")
        st.progress(min(res['ur_shear'], 1.0))
        st.caption(f"å½“å‰: {res['ur_shear']:.2f}")

        if res['ur_max'] > 1.0:
            st.error("âŒ æˆªé¢å¼ºåº¦ä¸è¶³ï¼è¯·åŠ å¤§åšåº¦æˆ–ç‚¹å‡»è‡ªåŠ¨ä¼˜åŒ–ã€‚")
        elif res['ur_max'] < 0.8:
            st.warning("âš ï¸ æˆªé¢è¿‡äºä¿å®ˆï¼Œå­˜åœ¨æµªè´¹ã€‚å»ºè®®ç‚¹å‡»è‡ªåŠ¨ä¼˜åŒ–ã€‚")
        else:
            st.success("âœ… æˆªé¢è®¾è®¡åˆç† (0.8 ~ 1.0)ã€‚")

if __name__ == "__main__":
    main()
